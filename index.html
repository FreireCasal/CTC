<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>India CTC and Net Take Home Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (3. Spacing & Typography) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 1. COLOR SYSTEM & 3. TYPOGRAPHY */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        /* Set base text color for the entire application (1. Gray 6) */
        #calculator-app, 
        .input-group label, 
        .summary-item h4, 
        .summary-item p {
            color: #323232 !important; /* Gray 6: All text on light backgrounds */
        }
        
        /* A) INPUT BAR (Top Panel) */
        .input-panel-container {
            background-color: #F8F8F8;
            border: 1px solid #DFDFDF; /* Gray 3 border */
            border-radius: 8px;
            padding: 1.5rem;
        }
        .input-group label {
            font-size: 13px; /* 3. Typography: Small labels */
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: block; /* Ensure label is block */
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #DFDFDF; /* Gray 3 border */
            outline: none;
            transition: border-color 0.15s;
            background-color: white; /* Fix visual overlap issue */
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #55AAC3; /* Blue focus indicator */
            box-shadow: 0 0 0 1px #55AAC3;
        }

        /* B) SUMMARY CARD */
        .summary-card-container {
            background-color: white;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05); /* Subtle shadow */
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1.5rem;
            border: 1px solid #F0F0F0; /* Light border for definition */
        }
        @media (min-width: 768px) {
            .summary-card-container {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        .summary-item h4 {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        .summary-item p {
            font-size: 18px;
            font-weight: 700;
        }

        /* C) TABLE REDESIGN */
        .result-table-card {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #DFDFDF; /* Gray 3 border */
            background-color: white;
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05);
        }
        .result-table {
            table-layout: fixed;
        }
        .result-table th, .result-table td {
            padding: 10px 12px; /* 3. Reduced padding to ~10-12px */
            font-size: 14px; /* 3. Row labels: 13â€“14px, Numeric values: 14px */
            color: #323232; /* Gray 6 */
            border-bottom: 1px solid #DFDFDF; /* Gray 3 Table grid/lines */
        }
        .result-table thead th {
            font-weight: 600;
            background-color: #DFDFDF; /* Gray 3 background (Table header row) */
            border-bottom: 1px solid #DFDFDF;
            font-size: 13px;
        }
        /* Right-align numeric values (C) */
        .result-table td:nth-child(2), 
        .result-table td:nth-child(3) {
            text-align: right; 
            font-weight: 500;
        }
        .result-table th {
            text-align: left;
            font-weight: 400; /* Regular weight for data labels */
        }
        /* Remove bottom border on the last visible row before a section header or a footer */
        .result-table tbody tr:last-child td, 
        .result-table tbody tr:last-child th {
             border-bottom: none;
        }
        
        /* D) SECTION TITLES (Band Headers) */
        .section-header-band th {
            background-color: #DFDFDF; /* Gray 3 */
            color: #323232; /* Gray 6 */
            font-size: 15px; /* 3. Section titles: 14â€“15px */
            font-weight: 600; /* Medium font weight */
            padding: 8px 12px;
            border-bottom: 1px solid #DFDFDF;
            border-top: 1px solid #DFDFDF;
        }
        
        /* E) COLOR BARS FOR SUBTOTALS (Subtotal Rows Only) */
        .subtotal-bar th, .subtotal-bar td {
            font-weight: 700;
            color: white !important; /* Default white text on colored bars for contrast */
            border-bottom: none;
            font-size: 14px;
        }
        
        /* FIXED CTC & TOTAL CTC (Blue) */
        .subtotal-bar-blue th, .subtotal-bar-blue td {
            background-color: #55AAC3; /* Blue */
        }
        
        /* Income Tax estimate (Orange) */
        .subtotal-bar-tax th, .subtotal-bar-tax td {
            background-color: #FFCB8B; /* Orange */
            color: #323232 !important; /* Gray 6 text for contrast on light orange */
        }
        
        /* TOTAL DEDUCTION (Purple) */
        .subtotal-bar-deduction th, .subtotal-bar-deduction td {
            background-color: #B38DC8; /* Purple */
        }

        /* NET TAKE HOME (Green 3) */
        .subtotal-bar-net th, .subtotal-bar-net td {
            background-color: #5EBA83; /* Green 3 */
            font-size: 16px;
        }
        
        /* Old Regime Info Box & New Warning Banner Style Match */
        .old-regime-info {
            background-color: #fffbeb;
            border: 1px solid #fde68a;
            color: #b45309;
        }
        
        /* Collapsible details for allowances */
        .allowance-details summary {
            cursor: pointer;
            padding: 10px 12px;
            background-color: #f7f7f7; /* Soft gray */
            border-bottom: 1px solid #DFDFDF;
            font-weight: 500;
            color: #55AAC3;
            list-style: none;
        }
        .allowance-details summary::-webkit-details-marker {
            display: none;
        }
        .allowance-details ul {
            padding: 10px 24px;
            background-color: white;
            border-left: 3px solid #55AAC3;
        }
        .allowance-details li {
            font-size: 13px;
            margin-bottom: 4px;
            list-style: disc;
            margin-left: 20px;
        }
        /* New Footer Styling */
        .app-footer {
            max-width: 48rem; /* Match max-w-4xl */
            padding: 1rem 0;
            margin-top: 1rem;
            /* REMOVED: text-align: center; */
            text-align: left; /* NEW: Left-aligned */
        }
        .app-footer p, .app-footer a {
            font-size: 11px; /* Extra small */
            color: #888888; /* Darker gray for minimal contrast */
            line-height: 1.5;
        }
        .app-footer a {
            color: #55AAC3; /* Blue link color */
            text-decoration: underline;
        }
    </style>
</head>
<body>

<div id="calculator-app" class="w-full max-w-4xl bg-white rounded-xl p-8">
    <h1 class="text-2xl font-bold mb-6 text-center" style="color: #323232;">India CTC & Net Take Home Estimator</h1>
    <p class="text-sm text-center mb-6" style="color: #323232;">Enter the <span class="font-bold">Annual Gross Salary</span> and select your options to calculate the full CTC breakdown.</p>

    <!-- INPUT BAR (A) -->
    <div id="inputs-section" class="input-panel-container mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- 1) Annual Gross Salary Input -->
            <div class="input-group">
                <label for="grossSalary">Annual Gross Salary (INR)</label> 
                <div class="relative">
                    <input type="number" id="grossSalary" placeholder="0" min="0" class="pr-3" oninput="calculateCTC()">
                </div>
            </div>

            <!-- Tax Regime Selection (No icon change here) -->
            <div class="input-group">
                <label>Income Tax Regime</label>
                <select id="taxRegime" onchange="calculateCTC()">
                    <option value="new">New Regime (Slab Tax)</option>
                    <option value="old">Old Regime (Slab Tax)</option>
                </select>
            </div>

            <!-- 2) Employer PF Contribution Selection -->
            <div class="input-group">
                <label>Employer PF Contribution</label>
                <div class="relative">
                    <select id="pfOption" class="pr-3" onchange="calculateCTC()">
                        <option value="percentage">12% of Basic Salary</option>
                        <!-- CHANGE: Replace "INR" with "â‚¹" -->
                        <option value="fixed">â‚¹1,800 per month (â‚¹21,600 annual)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: RESULTS CONTAINER - Initially hidden, shown only on valid input -->
    <div id="results-block" class="hidden">

        <!-- SUMMARY CARD (B) -->
        <div class="summary-card-container mb-8">
            <div class="summary-item">
                <h4>Annual CTC</h4>
                <p id="summaryAnnualCTC" style="color: #55AAC3;">â€”</p>
            </div>
            <div class="summary-item">
                <h4>Monthly Net Take Home</h4>
                <p id="summaryNetTakeHomeMonthly" style="color: #5EBA83;">â€”</p>
            </div>
            <div class="summary-item">
                <h4>PF Mode</h4>
                <p id="summaryPFMode" class="text-sm">â€”</p>
            </div>
            <div class="summary-item">
                <h4>Tax Regime</h4>
                <p id="summaryTaxRegime" class="text-sm">â€”</p>
            </div>
        </div>

        <!-- OLD REGIME LOW SALARY WARNING BANNER -->
        <div id="lowSalaryWarning" class="p-4 old-regime-info rounded-lg mb-8 hidden">
            <h3 class="text-base font-semibold mb-2">Salary Breakdown Adjustment</h3>
            <p class="text-sm">At this salary level, the suggested fixed allowances exceed the available Fixed CTC budget. Several optional allowances have been reduced or zeroed out (starting from Books & Periodicals) to ensure the breakdown fits within your Annual CTC budget.</p>
        </div>

        <!-- ðŸ§± BLOCK 1 â€” Information Block (New) -->
        <div id="newExemptionBanner" class="p-4 old-regime-info rounded-lg mb-8 hidden">
            <!-- 2 & 3: Collapsible Header Row and Icon -->
            <div class="flex items-center justify-between cursor-pointer" onclick="document.getElementById('oldRegimeInfoContent').classList.toggle('hidden');">
                <h3 class="text-base font-bold mb-3">Flexible Allowances & Exemption Limits (Old Regime)</h3>
                <button id="oldRegimeInfoToggle" class="w-7 h-7 flex items-center justify-center rounded-full bg-yellow-500 text-white font-semibold">i</button>
            </div>

            <!-- 1: Content (Initially hidden via JS at load) -->
            <div id="oldRegimeInfoContent" class="hidden">
                <p class="text-sm mb-4">The flexible allowances in this section are capped at their respective exemption limits. This calculator automatically allocates as much as possible within those limits based on your salary. When the salary is too low to fund all allowances, some allowances will be reduced to zero and the remaining balance stays in Special Allowance (fully taxable).</p>
                
                <!-- CLEANED UP LIST FORMAT -->
                <div class="grid grid-cols-1 md:grid-cols-2 text-sm gap-x-6 gap-y-1">
                    <ul class="list-disc ml-5 space-y-1 text-sm text-yellow-900">
                        <!-- REMOVED: "Meal allowance â€“ Max exemption INR 36,000/year." -->
                        <li class="pl-1">Periodicals & journals â€“ Max exemption INR 36,000/year.</li>
                        <li class="pl-1">Leave travel allowance â€“ Max entitlement = 1 month of basic salary.</li>
                        <li class="pl-1">Car running & maintenance â€“ Max exemption INR 28,800/year.</li>
                    </ul>
                    <ul class="list-disc ml-5 space-y-1 text-sm text-yellow-900">
                        <li class="pl-1">Telephone / communication allowance â€“ Max exemption INR 36,000/year.</li>
                        <li class="pl-1">Professional development allowance â€“ Max exemption INR 36,000/year.</li>
                        <li class="pl-1">Children education allowance â€“ Max exemption INR 2,400/year.</li>
                        <li class="pl-1">Sodexo / meal coupons â€“ company can opt for 13,200, 26,400 or 36,000 INR per year; assume 36,000 for this calculator.</li>
                    </ul>
                </div>
            </div>
        </div>


        <!-- ðŸ§± BLOCK 2 â€” CTC Breakdown Table (Refactored) -->
        <div id="results-container" class="result-table-card">
            
            <!-- Conditional Table Rendering: New Regime vs. Old Regime -->
            <table id="ctc-table-new" class="result-table w-full border-collapse" style="display: none;">
                <!-- NEW REGIME TABLE (SIMPLE STRUCTURE) -->
                <thead>
                    <tr>
                        <th class="w-1/2">Description</th>
                        <th class="w-1/4">Annual (â‚¹)</th>
                        <th class="w-1/4">Monthly (â‚¹)</th>
                    </tr>
                </thead>
                <tbody>
                    
                    <!-- Section 1: Direct Benefits (Fixed CTC Components) -->
                    <tr class="section-header-band">
                        <th colspan="3">I. Direct Benefits (Fixed CTC Components)</th>
                    </tr>
                    <tr>
                        <th>Basic Salary (50% on CTC)</th>
                        <td id="basicAnnualNew">â€”</td>
                        <td id="basicMonthlyNew">â€”</td>
                    </tr>
                    <tr>
                        <th>HRA (40% on Basic)</th>
                        <td id="hraAnnualNew">â€”</td>
                        <td id="hraMonthlyNew">â€”</td>
                    </tr>
                    <tr>
                        <th>Special Allowance</th>
                        <td id="specialAllowanceAnnualNew">â€”</td>
                        <td id="specialAllowanceMonthlyNew">â€”</td>
                    </tr>
                    
                    <!-- Subtotal: FIXED CTC (Blue) -->
                    <tr class="subtotal-bar subtotal-bar-blue">
                        <th>FIXED CTC</th>
                        <td id="fixedCTCAnnualNew">â€”</td>
                        <td id="fixedCTCMonthlyNew">â€”</td>
                    </tr>

                    <!-- Section 2: Employer Savings (PF) -->
                    <tr class="section-header-band">
                        <th colspan="3">II. Employer Savings (PF)</th>
                    </tr>
                    <tr>
                        <th>Employer PF Contribution (<span id="pfRateDisplayNew">12% of Basic Salary</span>)</th>
                        <td id="employerPFAnnualNew">â€”</td>
                        <td id="employerPFMonthlyNew">â€”</td>
                    </tr>

                    <!-- Section 3: Cost to Company (Total CTC) -->
                    <tr class="section-header-band">
                        <th colspan="3">III. Cost to Company (Total CTC)</th>
                    </tr>
                    <!-- Subtotal: TOTAL CTC (Blue) -->
                    <tr class="subtotal-bar subtotal-bar-blue">
                        <th>TOTAL CTC</th>
                        <td id="annualCTCNew">â€”</td>
                        <td id="monthlyCTCNew">â€”</td>
                    </tr>
                    
                    <!-- Section 4: Employee Deductions -->
                    <tr class="section-header-band">
                        <th colspan="3">IV. Employee Deductions</th>
                    </tr>
                    
                    <!-- Deductions -->
                    <tr>
                        <th>Employee PF Contribution</th>
                        <td id="employeePFAnnualNew">â€”</td>
                        <td id="employeePFMonthlyNew">â€”</td>
                    </tr>
                    <tr>
                        <th>Professional Tax</th>
                        <td id="ptAnnualNew">â€”</td>
                        <td id="ptMonthlyNew">â€”</td>
                    </tr>
                    <!-- E) Subtotal: Income Tax Estimate (Orange) -->
                    <tr class="subtotal-bar subtotal-bar-tax">
                        <th>Income Tax (<span id="regimeDisplayNew">New Regime (Slab Tax)</span>)</th>
                        <td id="incomeTaxAnnualNew">â€”</td>
                        <td id="incomeTaxMonthlyNew">â€”</td>
                    </div>
                    
                    <!-- E) Subtotal: TOTAL DEDUCTION (Purple) -->
                    <tr class="subtotal-bar subtotal-bar-deduction">
                        <th>TOTAL DEDUCTION</th>
                        <td id="totalDeductionAnnualNew">â€”</td>
                        <td id="totalDeductionMonthlyNew">â€”</td>
                    </tr>
                    
                    <!-- D) Section 5: Net Take Home (Final) -->
                    <tr class="section-header-band">
                        <th colspan="3">V. Net Take Home (Final)</th>
                    </tr>
                    <!-- E) Final Take Home (Green 3) -->
                    <tr class="subtotal-bar subtotal-bar-net">
                        <th>TOTAL NET TAKE HOME (ESTIMATE)</th>
                        <td id="netTakeHomeAnnualNew">â€”</td>
                        <td id="netTakeHomeMonthlyNew">â€”</td>
                    </tr>
                </tbody>
            </table>

            <!-- OLD REGIME TABLE (EXPANDED STRUCTURE - Now grouped and simplified UI) -->
            <table id="ctc-table-old" class="result-table w-full border-collapse" style="display: none;">
                <thead>
                    <tr>
                        <th class="w-1/2">Description</th>
                        <th class="w-1/4">Annual (â‚¹)</th>
                        <th class="w-1/4">Monthly (â‚¹)</th>
                    </tr>
                </thead>
                <tbody>
                    
                    <!-- Section 1: Direct Benefits (Fixed CTC Components) -->
                    <tr class="section-header-band">
                        <th colspan="3">I. Direct Benefits (Fixed CTC Components)</th>
                    </tr>
                    <tr>
                        <th>Basic Salary (50% of CTC)</th>
                        <td id="basicAnnualOld">â€”</td>
                        <td id="basicMonthlyOld">â€”</td>
                    </tr>
                    <tr>
                        <th>House Rent Allowance (HRA) (40% of Basic)</th>
                        <td id="hraAnnualOld">â€”</td>
                        <td id="hraMonthlyOld">â€”</td>
                    </tr>
                    
                    <!-- REMOVED: Leave Travel Allowance (LTA) and Children Education Allowance (CEA) -->
                    <tr id="ltaRowOld" style="display: none;">
                        <th>Leave Travel Allowance (LTA) (1 Month Basic)</th>
                        <td id="ltaAnnualOld">â€”</td>
                        <td id="ltaMonthlyOld">â€”</td>
                    </tr>
                    <tr id="ceaRowOld" style="display: none;">
                        <th>Children Education Allowance (CEA)</th>
                        <td id="ceaAnnualOld">â€”</td>
                        <td id="ceaMonthlyOld">â€”</td>
                    </tr>

                    <!-- A. GROUPED ROW (Now includes LTA and CEA in its calculated sum) -->
                    <tr>
                        <th>Flexible Allowances (allocated)</th>
                        <td id="flexibleAnnualOld">â€”</td>
                        <td id="flexibleMonthlyOld">â€”</td>
                    </tr>
                    
                    <!-- HIDING INDIVIDUAL ALLOWANCE ROWS (Retained for JS calculations) -->
                    <tr id="telephoneRowOld" style="display: none;">
                        <th>Telephone/Internet Allowance</th>
                        <td id="telephoneAnnualOld">â€”</td>
                        <td id="telephoneMonthlyOld">â€”</td>
                    </tr>
                    <tr id="sodexoRowOld" style="display: none;">
                        <th>Meal/Sodexo Coupons</th>
                        <td id="sodexoAnnualOld">â€”</td>
                        <td id="sodexoMonthlyOld">â€”</td>
                    </tr>
                    <tr id="carRepairRowOld" style="display: none;">
                        <th>Car Repair & Maintenance</th>
                        <td id="carRepairAnnualOld">â€”</td>
                        <td id="carRepairMonthlyOld">â€”</td>
                    </tr>
                    <tr id="profDevRowOld" style="display: none;">
                        <th>Professional Development</th>
                        <td id="profDevAnnualOld">â€”</td>
                        <td id="profDevMonthlyOld">â€”</td>
                    </tr>
                    <tr id="booksRowOld" style="display: none;">
                        <th>Books & Periodicals</th>
                        <td id="booksAnnualOld">â€”</td>
                        <td id="booksMonthlyOld">â€”</td>
                    </tr>
                    <!-- END HIDING -->
                    
                    <tr>
                        <th>Special Allowance (Balancing Figure)</th>
                        <td id="specialAllowanceAnnualOld">â€”</td>
                        <td id="specialAllowanceMonthlyOld">â€”</td>
                    </tr>
                    
                    <!-- E) Subtotal: FIXED CTC (Blue) -->
                    <tr class="subtotal-bar subtotal-bar-blue">
                        <th>FIXED CTC (Annual Gross Salary)</th>
                        <td id="fixedCTCAnnualOld">â€”</td>
                        <td id="fixedCTCMonthlyOld">â€”</td>
                    </tr>

                    <!-- D) Section 2: Employer Savings (PF) -->
                    <tr class="section-header-band">
                        <th colspan="3">II. Employer Savings (PF)</th>
                    </tr>
                    <tr>
                        <th>Employer PF Contribution (<span id="pfRateDisplayOld">12% of Basic Salary</span>)</th>
                        <td id="employerPFAnnualOld">â€”</td>
                        <td id="employerPFMonthlyOld">â€”</td>
                    </tr>

                    <!-- D) Section 3: Cost to Company (Total CTC) -->
                    <tr class="section-header-band">
                        <th colspan="3">III. Cost to Company (Total CTC)</th>
                    </tr>
                    <!-- E) Subtotal: TOTAL CTC (Blue) -->
                    <tr class="subtotal-bar subtotal-bar-blue">
                        <th>ANNUAL CTC</th>
                        <td id="annualCTCOld">â€”</td>
                        <td id="monthlyCTCOld">â€”</td>
                    </tr>
                    
                    <!-- D) Section 4: Employee Deductions -->
                    <tr class="section-header-band">
                        <th colspan="3">IV. Employee Deductions</th>
                    </tr>
                    
                    <!-- Deductions -->
                    <tr>
                        <th>Employee PF Contribution</th>
                        <td id="employeePFAnnualOld">â€”</td>
                        <td id="employeePFMonthlyOld">â€”</td>
                    </tr>
                    <tr>
                        <th>Professional Tax</th>
                        <td id="ptAnnualOld">â€”</td>
                        <td id="ptMonthlyOld">â€”</td>
                    </tr>
                    <!-- E) Subtotal: Income Tax Estimate (Orange) -->
                    <tr class="subtotal-bar subtotal-bar-tax">
                        <th>Estimated Income Tax (<span id="regimeDisplayOld">Old Regime (Slab Tax)</span>)</th>
                        <td id="incomeTaxAnnualOld">â€”</td>
                        <td id="incomeTaxMonthlyOld">â€”</td>
                    </tr>
                    
                    <!-- E) Subtotal: TOTAL DEDUCTION (Purple) -->
                    <tr class="subtotal-bar subtotal-bar-deduction">
                        <th>Total Payroll Deductions (PF + Profession Tax)</th> 
                        <td id="totalDeductionAnnualOld">â€”</td>
                        <td id="totalDeductionMonthlyOld">â€”</td>
                    </tr>
                    
                    <!-- D) Section 5: Net Take Home (Final) -->
                    <tr class="section-header-band">
                        <th colspan="3">V. Net Take Home (Final)</th>
                    </tr>
                    <!-- E) Final Take Home (Green 3) -->
                    <tr class="subtotal-bar subtotal-bar-net">
                        <th>TOTAL NET TAKE HOME (ESTIMATE)</th>
                        <td id="netTakeHomeAnnualOld">â€”</td>
                        <td id="netTakeHomeMonthlyOld">â€”</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Collapsible Allowance Breakdown -->
        <details id="allowanceBreakdownDetails" class="allowance-details w-full max-w-4xl mt-6 hidden">
            <summary>View detailed flexible allowance breakdown (optional)</summary>
            <ul id="flexibleBreakdownList">
                <!-- Content populated by JS -->
            </ul>
        </details>

        <!-- 1) DOWNLOAD BUTTON (Moved inside #results-block, centered) -->
        <div class="flex justify-center mt-6 w-full">
            <button onclick="downloadPDF()" class="bg-[#55AAC3] hover:bg-[#3F8DA6] text-white font-semibold py-2 px-6 rounded-lg shadow-lg transition duration-150 flex items-center">
                <!-- Document/Download Icon -->
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Download Full PDF Report
            </button>
        </div>

        <!-- 2) DISCLAIMER + REFERENCES FOOTER (Moved inside #results-block, left-aligned) -->
        <div class="app-footer w-full" style="text-align: left;">
            <!-- 1) Disclaimer Text -->
            <p class="text-xs text-gray-500 mt-4" style="color: #888888; font-size: 11px;">
                Disclaimer: This tool provides an <strong>estimation</strong> strictly based on the defined model logic. Actual tax and net take-home salary may vary significantly.
            </p>
            <!-- 2) References -->
            <p class="text-xs mt-2" style="color: #888888; font-size: 11px;">
                <strong>References:</strong>
                <br>
                â€“ Income tax slabs â€“ <a href="https://www.incometax.gov.in/" target="_blank">Government of India</a>
                <br>
                â€“ Provident Fund rates â€“ <a href="https://www.epfindia.gov.in/" target="_blank">EPFO</a>
                <br>
                â€“ Professional Tax and other local rules â€“ refer to your state governmentâ€™s official website.
            </p>
        </div>
    </div>
</div>

<!-- jsPDF and html2canvas CDNs for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
    // ---------------------------------------------------------------------------------------------------------
    // PROBLEM ANALYSIS & STRATEGY (1. Explanation & 2. Choice)
    // ---------------------------------------------------------------------------------------------------------
    /*
    ISSUE: For low Annual Gross Salary (G), the fixed allowances (LTA, CEA, Telephone, Sodexo, etc.) 
    are so high relative to the CTC that the Special Allowance (the balancing figure) becomes negative.
    
    STRATEGY: Strategy 'a' - Reduce/Zero out optional allowances based on priority.
    
    Implementation Details (For Old Regime only):
    1. Calculate FixedCTC and the sum of Basic + HRA (non-negotiable).
    2. Determine the remaining budget for optional allowances and Special Allowance.
    3. Iterate through optional allowances in reverse priority order (Books -> ProfDev -> ... -> LTA).
    4. If the budget runs out, reduce the allowances in that order to fit the budget.
    5. The remaining budget becomes the Special Allowance (which will always be >= 0).
    
    Priority Order (Highest to Lowest): 
    Basic, HRA (Non-Negotiable) 
    LTA, CEA, Telephone, Sodexo, Car Repair, Professional Dev, Books (Optional, highest to lowest priority)
    Special Allowance (Balancing Figure)

    UI MODIFICATION:
    - We are now grouping Telephone, Sodexo, Car Repair, Professional Dev, and Books & Periodicals 
      into a single "Flexible Allowances (allocated)" row for better UX in the Old Regime table view.
    - The underlying calculated values (telephone_annual_old, etc.) are still computed and 
      used for the final sum displayed in the grouped row.
    - The total FIXED CTC remains unchanged, as this is purely a visual grouping.
    */
    // ---------------------------------------------------------------------------------------------------------


    // --- 1) CONFIGURATION CONSTANTS (Annual Amounts) ---
    const CEA_ANNUAL = 2400;
    const TELEPHONE_ANNUAL = 36000;
    const SODEXO_ANNUAL = 36000;
    const CAR_REPAIR_ANNUAL = 28800; // UPDATED
    const PROF_DEV_ANNUAL = 36000;
    const BOOKS_ANNUAL = 36000;
    const PROFESSIONAL_TAX_ANNUAL = 2400;
    const MONTHS_PER_YEAR = 12;
    // Removed DRIVER_ANNUAL constant
    

    // --- 4. NUMBER FORMATTING (English-India Excel style) ---
    const formatCurrencyDisplay = (value) => {
        // Replace zero values with a dash 'â€”'
        if (value === 0 || value === null || isNaN(value)) {
            return 'â€”';
        }

        const roundedValue = Math.round(value);
        const isNegative = roundedValue < 0;
        const absValue = Math.abs(roundedValue);

        // Use en-US locale for Western grouping (600,000)
        const numberFormatter = new Intl.NumberFormat('en-US', {
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });

        const numberString = numberFormatter.format(absValue);

        // Construct the final string: [optional -] + â‚¹ + Space + numberString
        let result = `â‚¹ ${numberString}`;

        if (isNegative) {
            result = `-${result}`;
        }
        
        return result;
    };
    
    // --- TAX CALCULATION HELPERS (Based on the prompt slabs) ---

    // New Regime Tax Slabs (Includes 4% Cess)
    function computeNewRegimeTax(taxableIncome) {
        let tax = 0;
        let income = taxableIncome;
        
        // Slabs: 3L@0, 3-6L@5%, 6-9L@10%, 9-12L@15%, 12-15L@20%, >15L@30%
        if (income > 1500000) {
            tax += (income - 1500000) * 0.30;
            income = 1500000;
        }
        if (income > 1200000) {
            tax += (income - 1200000) * 0.20;
            income = 1200000;
        }
        if (income > 900000) {
            tax += (income - 900000) * 0.15;
            income = 900000;
        }
        if (income > 600000) {
            tax += (income - 600000) * 0.10;
            income = 600000;
        }
        if (income > 300000) {
            tax += (income - 300000) * 0.05;
            income = 300000;
        }
        
        let totalTax = tax * 1.04; // Apply 4% Cess
        
        return Math.round(Math.max(0, totalTax));
    }

    // Old Regime Tax Slabs (Includes 4% Cess)
    function computeOldRegimeTax(taxableIncome) {
        let tax = 0;
        let income = taxableIncome;

        // Slabs: 2.5L@0, 2.5-5L@5%, 5-10L@20%, >10L@30%
        if (income > 1000000) {
            tax += (income - 1000000) * 0.30;
            income = 1000000;
        }
        if (income > 500000) {
            tax += (income - 500000) * 0.20;
            income = 500000;
        }
        if (income > 250000) {
            tax += (income - 250000) * 0.05;
            income = 250000;
        }
        
        let totalTax = tax * 1.04; // Apply 4% Cess

        return Math.round(Math.max(0, totalTax));
    }

    // Helper to clear all results to 'â€”' (C)
    function clearResults() {
        // Collect all potential IDs for both tables
        const ids = [
            // New Regime IDs
            'annualCTCNew', 'monthlyCTCNew', 'basicAnnualNew', 'basicMonthlyNew', 'hraAnnualNew', 'hraMonthlyNew', 
            'specialAllowanceAnnualNew', 'specialAllowanceMonthlyNew', 'fixedCTCAnnualNew', 'fixedCTCMonthlyNew', 
            'employerPFAnnualNew', 'employerPFMonthlyNew', 'employeePFAnnualNew', 'employeePFMonthlyNew', 
            'ptAnnualNew', 'ptMonthlyNew', 'incomeTaxAnnualNew', 'incomeTaxMonthlyNew', 
            'totalDeductionAnnualNew', 'totalDeductionMonthlyNew', 'netTakeHomeAnnualNew', 'netTakeHomeMonthlyNew',
            
            // Old Regime IDs
            'annualCTCOld', 'monthlyCTCOld', 'basicAnnualOld', 'basicMonthlyOld', 'hraAnnualOld', 'hraMonthlyOld', 
            'ltaAnnualOld', 'ltaMonthlyOld', 'ceaAnnualOld', 'ceaMonthlyOld', 'telephoneAnnualOld', 'telephoneMonthlyOld', 
            'sodexoAnnualOld', 'sodexoMonthlyOld', 'carRepairAnnualOld', 'carRepairMonthlyOld', 'profDevAnnualOld', 'profDevMonthlyOld', 
            'booksAnnualOld', 'booksMonthlyOld', 'specialAllowanceAnnualOld', 'specialAllowanceMonthlyOld', 
            'fixedCTCAnnualOld', 'fixedCTCMonthlyOld', 'employerPFAnnualOld', 'employerPFMonthlyOld', 
            'employeePFAnnualOld', 'employeePFMonthlyOld', 'ptAnnualOld', 'ptMonthlyOld', 
            'incomeTaxAnnualOld', 'incomeTaxMonthlyOld', 'totalDeductionAnnualOld', 'totalDeductionMonthlyOld', 
            'netTakeHomeAnnualOld', 'netTakeHomeMonthlyOld',
            
            // New Grouped Allowance ID
            'flexibleAnnualOld', 'flexibleMonthlyOld'
        ];
        
        ids.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = 'â€”';
        });
        
        // Clear summary card explicitly with placeholder values
        updateSummaryCard('â€”', 'â€”');
    }

    // --- NEW FUNCTION: Update Summary Card (Requirement 2, 3, 4) ---
    /**
     * Updates the top summary card strip based on the final computed values.
     * @param {number} annualCTC The calculated total CTC (annual).
     * @param {number} netMonthly The calculated net take home (monthly) for the current regime.
     */
    function updateSummaryCard(annualCTC, netMonthly) {
        const pfOption = document.getElementById('pfOption');
        const taxRegime = document.getElementById('taxRegime');

        // 1. Annual CTC
        document.getElementById('summaryAnnualCTC').textContent = formatCurrencyDisplay(annualCTC);
        
        // 2. Monthly Net Take Home
        document.getElementById('summaryNetTakeHomeMonthly').textContent = formatCurrencyDisplay(netMonthly);
        
        // 3. PF Mode
        document.getElementById('summaryPFMode').textContent = pfOption.options[pfOption.selectedIndex].textContent;
        
        // 4. Tax Regime
        document.getElementById('summaryTaxRegime').textContent = taxRegime.options[taxRegime.selectedIndex].textContent;
    }


    // --- MAIN CTC CALCULATION ---
    
    function calculateCTC() {
        const grossSalaryInput = document.getElementById('grossSalary').value;
        const annual_gross_salary = parseFloat(grossSalaryInput) || 0;
        
        const pf_mode_selection = document.getElementById('pfOption').value;
        const tax_regime = document.getElementById('taxRegime').value;
        const pf_mode = (pf_mode_selection === 'percentage') ? 'PERCENT_12' : 'FIXED_1800';
        
        // NEW UX LOGIC: Show/Hide results block based on valid input
        const resultsBlock = document.getElementById('results-block');

        if (annual_gross_salary <= 0) {
            clearResults();
            if (resultsBlock) resultsBlock.classList.add('hidden');
            renderTable(tax_regime); // Still render tables in background to set up structure
            return;
        }

        if (resultsBlock) resultsBlock.classList.remove('hidden'); // Show results block on valid input

        // --- 1) ANNUAL CTC (Derived from Gross) ---
        const annual_ctc_derived = Math.round(annual_gross_salary / 0.94);

        // --- 2) BASIC (50% of CTC) AND HRA (40% OF BASIC) ---
        const basic_annual = Math.round(annual_ctc_derived * 0.50);
        const basic_monthly = Math.round(basic_annual / MONTHS_PER_YEAR);
        const hra_annual = Math.round(basic_annual * 0.40);
        const hra_monthly = Math.round(hra_annual / MONTHS_PER_YEAR);

        
        // --- PF/CTC LOGIC ADJUSTMENT START (UNCHANGED) ---
        
        // 2. Employer PF (Component of CTC) - ALWAYS 12% of Basic, regardless of dropdown choice.
        const employer_pf_annual_ctc = Math.round(basic_annual * 0.12);
        const employer_pf_monthly_ctc = Math.round(employer_pf_annual_ctc / MONTHS_PER_YEAR);

        // 1. Total CTC - ALWAYS calculated using the fixed Employer PF Contribution
        const fixed_ctc_annual = annual_gross_salary;
        const total_ctc_annual = fixed_ctc_annual + employer_pf_annual_ctc; 
        
        // 3. Employee PF (Deduction from Net Take Home) - Varies based on dropdown
        let employee_pf_annual_deduction;
        let employee_pf_monthly_deduction;

        if (pf_mode === "PERCENT_12") {
            // Employee PF deduction is 12% of Basic, mirroring the standard contribution amount
            employee_pf_annual_deduction = employer_pf_annual_ctc; 
            employee_pf_monthly_deduction = employer_pf_monthly_ctc;
        } else { // pf_mode === "FIXED_1800" (INR 1,800 per month)
            // Employee PF deduction is fixed at 21,600 annual (1800 * 12)
            employee_pf_monthly_deduction = 1800;
            employee_pf_annual_deduction = employee_pf_monthly_deduction * MONTHS_PER_YEAR;
        }
        
        // --- PF/CTC LOGIC ADJUSTMENT END ---


        // --- FIXED CTC (FixedCTC = Annual Gross Salary (G)) ---
        
        const fixed_ctc_monthly = Math.round(fixed_ctc_annual / MONTHS_PER_YEAR);
        
        // --- DEDUCTIONS ---
        const prof_tax_annual = PROFESSIONAL_TAX_ANNUAL;
        const prof_tax_monthly = Math.round(prof_tax_annual / MONTHS_PER_YEAR);
        const taxable_income = fixed_ctc_annual;
        let income_tax_annual, income_tax_monthly;

        if (tax_regime === "new") {
            income_tax_annual = computeNewRegimeTax(taxable_income);
        } else {
            income_tax_annual = computeOldRegimeTax(taxable_income); 
        }
        income_tax_monthly = Math.round(income_tax_annual / MONTHS_PER_YEAR);

        
        // --- LOGIC SPLIT: NEW REGIME VS OLD REGIME BREAKDOWN ---

        // Variables for Old Regime calculation
        let lta_annual_old = 0, cea_annual_old = 0, telephone_annual_old = 0, sodexo_annual_old = 0, car_repair_annual_old = 0;
        let prof_dev_annual_old = 0, books_annual_old = 0, special_allowance_annual_old = 0;
        let low_salary_flag = false;

        // Variables for Net Take Home Calculation (Initialised for both paths)
        let total_deductions_annual_current;
        let total_deductions_monthly_current;
        let net_take_home_annual_current;
        let net_take_home_monthly_current;
        
        if (tax_regime === 'old') {
            // --- OLD REGIME: ADJUSTING ALLOWANCES TO PREVENT NEGATIVE SPECIAL ALLOWANCE ---
            
            const sum_non_negotiable = basic_annual + hra_annual;
            let budget_remaining = fixed_ctc_annual - sum_non_negotiable;

            // 2) Old Regime optional_allowances_calc object with updated constants
            const optional_allowances_calc = {
                books_annual: BOOKS_ANNUAL,
                prof_dev_annual: PROF_DEV_ANNUAL,
                car_repair_annual: CAR_REPAIR_ANNUAL,
                sodexo_annual: SODEXO_ANNUAL,
                telephone_annual: TELEPHONE_ANNUAL,
                cea_annual: CEA_ANNUAL,
                lta_annual: basic_monthly, // LTA (1 Month Basic)
            };

            let required_optional_sum = Object.values(optional_allowances_calc).reduce((sum, val) => sum + val, 0);

            if (budget_remaining < required_optional_sum) {
                low_salary_flag = true;
                
                // Priority keys must match the allowance names in the optional_allowances_calc object
                const priority_keys = [
                    'books_annual', 'prof_dev_annual', 'car_repair_annual', 'sodexo_annual', 
                    'telephone_annual', 'cea_annual', 'lta_annual'
                ];

                let current_optional_sum = required_optional_sum;

                for (const key of priority_keys) {
                    const allowance_value = optional_allowances_calc[key];
                    
                    if (budget_remaining <= 0) {
                        optional_allowances_calc[key] = 0;
                    } 
                    else if (current_optional_sum > budget_remaining) {
                        const amount_to_cut = current_optional_sum - budget_remaining;
                        
                        if (amount_to_cut >= allowance_value) {
                            optional_allowances_calc[key] = 0;
                        } else {
                            optional_allowances_calc[key] = allowance_value - amount_to_cut;
                        }
                    }
                    
                    current_optional_sum = Object.values(optional_allowances_calc).reduce((sum, val) => sum + val, 0);
                    
                    if (current_optional_sum <= budget_remaining) break;
                }

                special_allowance_annual_old = budget_remaining - current_optional_sum;
                
            } else {
                special_allowance_annual_old = budget_remaining - required_optional_sum;
            }
            
            // Assign calculated/adjusted values
            lta_annual_old = optional_allowances_calc.lta_annual;
            cea_annual_old = optional_allowances_calc.cea_annual;
            telephone_annual_old = optional_allowances_calc.telephone_annual;
            sodexo_annual_old = optional_allowances_calc.sodexo_annual;
            car_repair_annual_old = optional_allowances_calc.car_repair_annual;
            prof_dev_annual_old = optional_allowances_calc.prof_dev_annual;
            books_annual_old = optional_allowances_calc.books_annual;

            special_allowance_annual_old = Math.round(Math.max(0, special_allowance_annual_old));

            // --- A. GROUPING THE OPTIONAL ALLOWANCES ---
            // 3. Sum the flexible/grouped allowances (NOW INCLUDES LTA and CEA)
            const flexible_allowances_annual_sum = Math.round(
                lta_annual_old + cea_annual_old + telephone_annual_old + sodexo_annual_old + car_repair_annual_old + prof_dev_annual_old + books_annual_old
            );
            const flexible_allowances_monthly_sum = Math.round(flexible_allowances_annual_sum / MONTHS_PER_YEAR);

            // Show/hide low salary warning
            const warningBox = document.getElementById('lowSalaryWarning');
            if (warningBox) {
                if (low_salary_flag) {
                    warningBox.classList.remove('hidden');
                } else {
                    warningBox.classList.add('hidden');
                }
            }
            
            // --- 4. OLD REGIME NET TAKE HOME LOGIC ---
            // Total deduction is PF deduction + Professional Tax (Tax is excluded)
            total_deductions_annual_current = employee_pf_annual_deduction + prof_tax_annual;
            total_deductions_monthly_current = Math.round(total_deductions_annual_current / MONTHS_PER_YEAR);

            net_take_home_annual_current = fixed_ctc_annual - total_deductions_annual_current; 
            net_take_home_monthly_current = Math.round(net_take_home_annual_current / MONTHS_PER_YEAR);
            
            // --- Update Old Regime UI (Detailed Rows) ---
            document.getElementById('basicAnnualOld').textContent = formatCurrencyDisplay(basic_annual);
            document.getElementById('basicMonthlyOld').textContent = formatCurrencyDisplay(basic_monthly);
            document.getElementById('hraAnnualOld').textContent = formatCurrencyDisplay(hra_annual);
            document.getElementById('hraMonthlyOld').textContent = formatCurrencyDisplay(hra_monthly);
            
            // LTA and CEA rows are now hidden, but values are still updated for the detail block
            document.getElementById('ltaAnnualOld').textContent = formatCurrencyDisplay(lta_annual_old);
            document.getElementById('ltaMonthlyOld').textContent = formatCurrencyDisplay(Math.round(lta_annual_old / MONTHS_PER_YEAR));
            document.getElementById('ceaAnnualOld').textContent = formatCurrencyDisplay(cea_annual_old);
            document.getElementById('ceaMonthlyOld').textContent = formatCurrencyDisplay(Math.round(cea_annual_old / MONTHS_PER_YEAR));
            
            // A. Update Grouped Row
            document.getElementById('flexibleAnnualOld').textContent = formatCurrencyDisplay(flexible_allowances_annual_sum);
            document.getElementById('flexibleMonthlyOld').textContent = formatCurrencyDisplay(flexible_allowances_monthly_sum);

            // Update hidden/detailed breakdown list for the collapsible section
            const breakdownList = document.getElementById('flexibleBreakdownList');
            if (breakdownList) {
                breakdownList.innerHTML = `
                    <li>Leave Travel Allowance (LTA): ${formatCurrencyDisplay(lta_annual_old)}</li>
                    <li>Children Education Allowance (CEA): ${formatCurrencyDisplay(cea_annual_old)}</li>
                    <li>Telephone/Internet Allowance: ${formatCurrencyDisplay(telephone_annual_old)}</li>
                    <li>Meal/Sodexo Coupons: ${formatCurrencyDisplay(sodexo_annual_old)}</li>
                    <li>Car Repair & Maintenance: ${formatCurrencyDisplay(car_repair_annual_old)}</li>
                    <li>Professional Development: ${formatCurrencyDisplay(prof_dev_annual_old)}</li>
                    <li>Books & Periodicals: ${formatCurrencyDisplay(books_annual_old)}</li>
                `;
            }

            // Update remaining Old Regime UI
            document.getElementById('specialAllowanceAnnualOld').textContent = formatCurrencyDisplay(special_allowance_annual_old);
            document.getElementById('specialAllowanceMonthlyOld').textContent = formatCurrencyDisplay(Math.round(special_allowance_annual_old / MONTHS_PER_YEAR));
            document.getElementById('fixedCTCAnnualOld').textContent = formatCurrencyDisplay(fixed_ctc_annual);
            document.getElementById('fixedCTCMonthlyOld').textContent = formatCurrencyDisplay(fixed_ctc_monthly);
            
            // Employer PF (CTC Component)
            document.getElementById('employerPFAnnualOld').textContent = formatCurrencyDisplay(employer_pf_annual_ctc);
            document.getElementById('employerPFMonthlyOld').textContent = formatCurrencyDisplay(employer_pf_monthly_ctc);
            
            document.getElementById('annualCTCOld').textContent = formatCurrencyDisplay(total_ctc_annual);
            document.getElementById('monthlyCTCOld').textContent = formatCurrencyDisplay(Math.round(total_ctc_annual / MONTHS_PER_YEAR));
            
            // Employee PF (Deduction Component)
            document.getElementById('employeePFAnnualOld').textContent = formatCurrencyDisplay(employee_pf_annual_deduction);
            document.getElementById('employeePFMonthlyOld').textContent = formatCurrencyDisplay(employee_pf_monthly_deduction);
            
            document.getElementById('ptAnnualOld').textContent = formatCurrencyDisplay(prof_tax_annual);
            document.getElementById('ptMonthlyOld').textContent = formatCurrencyDisplay(prof_tax_monthly);
            document.getElementById('incomeTaxAnnualOld').textContent = formatCurrencyDisplay(income_tax_annual);
            document.getElementById('incomeTaxMonthlyOld').textContent = formatCurrencyDisplay(income_tax_monthly);
            document.getElementById('totalDeductionAnnualOld').textContent = formatCurrencyDisplay(total_deductions_annual_current);
            document.getElementById('totalDeductionMonthlyOld').textContent = formatCurrencyDisplay(total_deductions_monthly_current);
            document.getElementById('netTakeHomeAnnualOld').textContent = formatCurrencyDisplay(net_take_home_annual_current);
            document.getElementById('netTakeHomeMonthlyOld').textContent = formatCurrencyDisplay(net_take_home_monthly_current);
        } else {
             // New Regime (Simple structure) 
             
            // 4. NEW REGIME NET TAKE HOME LOGIC: fixed_ctc_annual - (employee_pf_annual + professional_tax_annual + income_tax_annual)
            total_deductions_annual_current = employee_pf_annual_deduction + prof_tax_annual + income_tax_annual;
            total_deductions_monthly_current = Math.round(total_deductions_annual_current / MONTHS_PER_YEAR);
            net_take_home_annual_current = fixed_ctc_annual - total_deductions_annual_current;
            net_take_home_monthly_current = Math.round(net_take_home_annual_current / MONTHS_PER_YEAR);

            document.getElementById('basicAnnualNew').textContent = formatCurrencyDisplay(basic_annual);
            document.getElementById('basicMonthlyNew').textContent = formatCurrencyDisplay(basic_monthly);
            document.getElementById('hraAnnualNew').textContent = formatCurrencyDisplay(hra_annual);
            document.getElementById('hraMonthlyNew').textContent = formatCurrencyDisplay(hra_monthly);
            
            const SA_New = fixed_ctc_annual - basic_annual - hra_annual;
            document.getElementById('specialAllowanceAnnualNew').textContent = formatCurrencyDisplay(SA_New);
            document.getElementById('specialAllowanceMonthlyNew').textContent = formatCurrencyDisplay(Math.round(SA_New / MONTHS_PER_YEAR));
            document.getElementById('fixedCTCAnnualNew').textContent = formatCurrencyDisplay(fixed_ctc_annual);
            document.getElementById('fixedCTCMonthlyNew').textContent = formatCurrencyDisplay(fixed_ctc_monthly);
            
            // Employer PF (CTC Component)
            document.getElementById('employerPFAnnualNew').textContent = formatCurrencyDisplay(employer_pf_annual_ctc);
            document.getElementById('employerPFMonthlyNew').textContent = formatCurrencyDisplay(employer_pf_monthly_ctc);
            
            document.getElementById('annualCTCNew').textContent = formatCurrencyDisplay(total_ctc_annual);
            document.getElementById('monthlyCTCNew').textContent = formatCurrencyDisplay(Math.round(total_ctc_annual / MONTHS_PER_YEAR));
            
            // Employee PF (Deduction Component)
            document.getElementById('employeePFAnnualNew').textContent = formatCurrencyDisplay(employee_pf_annual_deduction);
            document.getElementById('employeePFMonthlyNew').textContent = formatCurrencyDisplay(employee_pf_monthly_deduction);
            
            document.getElementById('ptAnnualNew').textContent = formatCurrencyDisplay(prof_tax_annual);
            document.getElementById('ptMonthlyNew').textContent = formatCurrencyDisplay(prof_tax_monthly);
            document.getElementById('incomeTaxAnnualNew').textContent = formatCurrencyDisplay(income_tax_annual);
            document.getElementById('incomeTaxMonthlyNew').textContent = formatCurrencyDisplay(income_tax_monthly);
            document.getElementById('totalDeductionAnnualNew').textContent = formatCurrencyDisplay(total_deductions_annual_current);
            document.getElementById('totalDeductionMonthlyNew').textContent = formatCurrencyDisplay(total_deductions_monthly_current);
            document.getElementById('netTakeHomeAnnualNew').textContent = formatCurrencyDisplay(net_take_home_annual_current);
            document.getElementById('netTakeHomeMonthlyNew').textContent = formatCurrencyDisplay(net_take_home_monthly_current);
        }

        // --- 5. SUMMARY STRIP UPDATE ---
        // Pass the fixed total CTC (based on 12% of Basic) and the calculated net monthly
        updateSummaryCard(total_ctc_annual, net_take_home_monthly_current);
        
        renderTable(tax_regime);
    }
    
    function renderTable(regime) {
        const tableNew = document.getElementById('ctc-table-new');
        const tableOld = document.getElementById('ctc-table-old');
        const warningBox = document.getElementById('lowSalaryWarning'); 
        const newBanner = document.getElementById('newExemptionBanner');
        const breakdownDetails = document.getElementById('allowanceBreakdownDetails');
        
        // Hide all conditional elements initially
        if (warningBox) warningBox.classList.add('hidden');
        if (newBanner) newBanner.classList.add('hidden');
        
        // Hide/Show breakdown details depending on regime (always hide initially)
        if (breakdownDetails) {
            if (regime === 'old') {
                breakdownDetails.classList.remove('hidden');
            } else {
                breakdownDetails.classList.add('hidden');
            }
        }

        if (regime === 'new') {
            tableNew.style.display = 'table';
            tableOld.style.display = 'none';
        } else {
            tableNew.style.display = 'none';
            tableOld.style.display = 'table';
            newBanner.classList.remove('hidden'); 
            
            // Warning visibility is controlled inside calculateCTC()
        }
    }

    // --- PDF Download Functionality (Captures the visible table) ---
    async function downloadPDF() {
        // Determine which table is currently visible and set it as the input element
        const isNewRegime = document.getElementById('taxRegime').value === 'new';
        
        // Capture the parent container, which is what html2canvas expects for sizing
        // We capture the whole results block to include the summary card and banners
        const input = document.getElementById('results-block'); 
        const { jsPDF } = window.jspdf;
        
        if (!input || input.classList.contains('hidden')) {
            console.error("PDF Error: 'results-block' element not found or hidden.");
            const messageBox = document.createElement('div');
            messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid red; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.2);';
            messageBox.innerHTML = '<strong>Error!</strong> Please enter a valid Annual Gross Salary first.';
            document.body.appendChild(messageBox);
            setTimeout(() => document.body.removeChild(messageBox), 4000);
            return;
        }

        calculateCTC(); 

        // Important: html2canvas captures the WHOLE div, which works best here.
        html2canvas(input, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgHeight = (canvas.height * pdfWidth) / canvas.width;

            // Add title text
            pdf.setFontSize(16);
            pdf.text('India CTC Breakdown & Net Take Home Estimate', pdfWidth / 2, 15, { align: 'center' });
            pdf.setFontSize(10);
            pdf.text('Generated on: ' + new Date().toLocaleDateString(), pdfWidth / 2, 22, { align: 'center' });

            // Add image of the captured content
            pdf.addImage(imgData, 'PNG', 10, 30, pdfWidth - 20, imgHeight * (pdfWidth - 20) / pdfWidth);
            
            // Add disclaimer
            pdf.setFontSize(8);
            pdf.text('Disclaimer: This tool provides an **estimation** for illustrative purposes only. Actual net take-home salary may vary based on company policies, investment declarations, and final tax calculations.', 10, pdfHeight - 10);
            
            pdf.save(`CTC_Breakdown_Report_${isNewRegime ? 'New' : 'Old'}_Regime.pdf`);
        }).catch(error => {
            console.error("Error generating PDF:", error);
            const messageBox = document.createElement('div');
            messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid red; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.2);';
            messageBox.innerHTML = '<strong>Error!</strong> Could not generate PDF. Please try again or check the console for details.';
            document.body.appendChild(messageBox);
            setTimeout(() => document.body.removeChild(messageBox), 3000);
        });
    }

    // Initialize on load
    window.onload = function() {
        clearResults(); 
        calculateCTC(); 
        // Initial render based on default dropdown value
        renderTable(document.getElementById('taxRegime').value);
    };

</script>
</body>
</html>