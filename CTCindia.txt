<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>India CTC and Net Take Home Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (3. Spacing & Typography) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 1. COLOR SYSTEM & 3. TYPOGRAPHY */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        /* Set base text color for the entire application (1. Gray 6) */
        #calculator-app, 
        .input-group label, 
        .summary-item h4, 
        .summary-item p {
            color: #323232 !important; /* Gray 6: All text on light backgrounds */
        }
        
        /* A) INPUT BAR (Top Panel) */
        .input-panel-container {
            background-color: #F8F8F8;
            border: 1px solid #DFDFDF; /* Gray 3 border */
            border-radius: 8px;
            padding: 1.5rem;
        }
        .input-group label {
            font-size: 13px; /* 3. Typography: Small labels */
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: block; /* Ensure label is block */
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #DFDFDF; /* Gray 3 border */
            outline: none;
            transition: border-color 0.15s;
            background-color: white; /* Fix visual overlap issue */
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #55AAC3; /* Blue focus indicator */
            box-shadow: 0 0 0 1px #55AAC3;
        }

        /* FIX: Increased padding for icon alignment (32px to 40px equivalent) */
        .input-with-icon {
            padding-left: 3rem !important; /* p-12 in Tailwind is 3rem = 48px, but since we are using fixed padding in the CSS above, we use an inline class or more specific styling */
        }

        /* B) SUMMARY CARD */
        .summary-card-container {
            background-color: white;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05); /* Subtle shadow */
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1.5rem;
            border: 1px solid #F0F0F0; /* Light border for definition */
        }
        @media (min-width: 768px) {
            .summary-card-container {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        .summary-item h4 {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        .summary-item p {
            font-size: 18px;
            font-weight: 700;
        }

        /* C) TABLE REDESIGN */
        .result-table-card {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #DFDFDF; /* Gray 3 border */
            background-color: white;
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.05);
        }
        .result-table {
            table-layout: fixed;
        }
        .result-table th, .result-table td {
            padding: 10px 12px; /* 3. Reduced padding to ~10-12px */
            font-size: 14px; /* 3. Row labels: 13–14px, Numeric values: 14px */
            color: #323232; /* Gray 6 */
            border-bottom: 1px solid #DFDFDF; /* Gray 3 Table grid/lines */
        }
        .result-table thead th {
            font-weight: 600;
            background-color: #DFDFDF; /* Gray 3 background (Table header row) */
            border-bottom: 1px solid #DFDFDF;
            font-size: 13px;
        }
        /* Right-align numeric values (C) */
        .result-table td:nth-child(2), 
        .result-table td:nth-child(3) {
            text-align: right; 
            font-weight: 500;
        }
        .result-table th {
            text-align: left;
            font-weight: 400; /* Regular weight for data labels */
        }
        /* Remove bottom border on the last visible row before a section header or a footer */
        .result-table tbody tr:last-child td, 
        .result-table tbody tr:last-child th {
             border-bottom: none;
        }
        
        /* D) SECTION TITLES (Band Headers) */
        .section-header-band th {
            background-color: #DFDFDF; /* Gray 3 */
            color: #323232; /* Gray 6 */
            font-size: 15px; /* 3. Section titles: 14–15px */
            font-weight: 600; /* Medium font weight */
            padding: 8px 12px;
            border-bottom: 1px solid #DFDFDF;
            border-top: 1px solid #DFDFDF;
        }
        
        /* E) COLOR BARS FOR SUBTOTALS (Subtotal Rows Only) */
        .subtotal-bar th, .subtotal-bar td {
            font-weight: 700;
            color: white !important; /* Default white text on colored bars for contrast */
            border-bottom: none;
            font-size: 14px;
        }
        
        /* FIXED CTC & TOTAL CTC (Blue) */
        .subtotal-bar-blue th, .subtotal-bar-blue td {
            background-color: #55AAC3; /* Blue */
        }
        
        /* Income Tax estimate (Orange) */
        .subtotal-bar-tax th, .subtotal-bar-tax td {
            background-color: #FFCB8B; /* Orange */
            color: #323232 !important; /* Gray 6 text for contrast on light orange */
        }
        
        /* TOTAL DEDUCTION (Purple) */
        .subtotal-bar-deduction th, .subtotal-bar-deduction td {
            background-color: #B38DC8; /* Purple */
        }

        /* NET TAKE HOME (Green 3) */
        .subtotal-bar-net th, .subtotal-bar-net td {
            background-color: #5EBA83; /* Green 3 */
            font-size: 16px;
        }
        
        /* Old Regime Info Box */
        .old-regime-info {
            background-color: #fffbeb;
            border: 1px solid #fde68a;
            color: #b45309;
        }
    </style>
</head>
<body>

<div id="calculator-app" class="w-full max-w-4xl bg-white rounded-xl p-8">
    <h1 class="text-2xl font-bold mb-6 text-center" style="color: #323232;">India CTC & Net Take Home Estimator</h1>
    <p class="text-sm text-center mb-6" style="color: #323232;">Enter the <span class="font-bold">Annual Gross Salary</span> and select your options to calculate the full CTC breakdown.</p>

    <!-- INPUT BAR (A) -->
    <div id="inputs-section" class="input-panel-container mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Annual Gross Salary Input -->
            <div class="input-group">
                <!-- FIX 1: Removed (₹) from the label -->
                <label for="grossSalary">Annual Gross Salary</label> 
                <div class="relative">
                    <!-- FIX 2: Icon repositioned slightly left (left-3) and centered -->
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0s1 4 5 4m-5 4h6m-1 3.5l1-1.5m-3-1l-1-1.5m3-1l1-1.5m-3-1l-1-1.5m2-2l-1-1.5m2 2V5m-4 14v-4m-3-1h8m-8-2h8m-8-2h8"></path></svg>
                    <!-- FIX 3: Increased padding to pl-12 (48px) for clear separation -->
                    <input type="number" id="grossSalary" placeholder="0" min="0" class="input-with-icon pl-12 pr-3" oninput="calculateCTC()">
                </div>
            </div>

            <!-- Tax Regime Selection (No icon change here) -->
            <div class="input-group">
                <label>Income Tax Regime</label>
                <select id="taxRegime" onchange="toggleOldRegimeAllowances(); calculateCTC()">
                    <option value="new">New Regime (Slab Tax)</option>
                    <option value="old">Old Regime (Slab Tax)</option>
                </select>
            </div>

            <!-- PF Contribution Selection -->
            <div class="input-group">
                <label>Employer PF Contribution</label>
                <div class="relative">
                    <!-- FIX 4: Icon in PF field is now visually aligned with input text padding -->
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 1.343 3 3s-1.343 3-3 3 1.343-3 3-3zM10 20v-5m4 0v5m-4-7h4m-4 0v-4m4 4h4m-4-4v4"></path></svg>
                    <!-- FIX 5: Increased padding to pl-12 (48px) for clear separation -->
                    <select id="pfOption" class="input-with-icon pl-12 pr-3" onchange="calculateCTC()">
                        <option value="percentage">12% of Basic Salary</option>
                        <option value="fixed">INR 1,800 per month (₹21,600 annual)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- SUMMARY CARD (B) -->
    <div class="summary-card-container mb-8">
        <div class="summary-item">
            <h4>Annual CTC</h4>
            <p id="summaryAnnualCTC" style="color: #55AAC3;">—</p>
        </div>
        <div class="summary-item">
            <h4>Monthly Net Take Home</h4>
            <p id="summaryNetTakeHomeMonthly" style="color: #5EBA83;">—</p>
        </div>
        <div class="summary-item">
            <h4>PF Mode</h4>
            <p id="summaryPFMode" class="text-sm">—</p>
        </div>
        <div class="summary-item">
            <h4>Tax Regime</h4>
            <p id="summaryTaxRegime" class="text-sm">—</p>
        </div>
    </div>

    <!-- OLD REGIME ALLOWANCES (Conditional - Information Only) -->
    <div id="oldRegimeAllowances" class="p-4 old-regime-info rounded-lg mb-8 hidden">
        <h3 class="text-base font-semibold mb-2">Old Regime Exemptions (Informational Only)</h3>
        <p class="text-sm mb-2">The components below are included in the Gross Salary breakdown, but for this simplified slab-based tax calculation, <span class="font-bold">no exemptions or deductions are applied</span> (HRA, Standard Deduction, 80C, etc., are ignored).</p>
    </div>

    <!-- C) RESULTS TABLE CONTAINER -->
    <div id="results-container" class="result-table-card">
        <table id="ctc-table" class="result-table w-full border-collapse">
            <thead>
                <tr>
                    <th class="w-1/2">Description</th>
                    <th class="w-1/4">Annual (₹)</th>
                    <th class="w-1/4">Monthly (₹)</th>
                </tr>
            </thead>
            <tbody>
                
                <!-- D) Section 1: Direct Benefits (Fixed CTC Components) -->
                <tr class="section-header-band">
                    <th colspan="3">I. Direct Benefits (Fixed CTC Components)</th>
                </tr>
                <tr>
                    <th>Basic Salary (50% of CTC)</th>
                    <td id="basicAnnual">—</td>
                    <td id="basicMonthly">—</td>
                </tr>
                <tr>
                    <th>House Rent Allowance (HRA) (40% of Basic)</th>
                    <td id="hraAnnual">—</td>
                    <td id="hraMonthly">—</td>
                </tr>
                <tr>
                    <th>Leave Travel Allowance (LTA) (1 Month Basic)</th>
                    <td id="ltaAnnual">—</td>
                    <td id="ltaMonthly">—</td>
                </tr>
                <tr>
                    <th>Children Education Allowance (CEA)</th>
                    <td id="ceaAnnual">—</td>
                    <td id="ceaMonthly">—</td>
                </tr>
                <tr>
                    <th>Telephone/Internet Allowance</th>
                    <td id="telephoneAnnual">—</td>
                    <td id="telephoneMonthly">—</td>
                </tr>
                <tr>
                    <th>Meal/Sodexo Coupons</th>
                    <td id="sodexoAnnual">—</td>
                    <td id="sodexoMonthly">—</td>
                </tr>
                <tr>
                    <th>Car Repair & Maintenance</th>
                    <td id="carRepairAnnual">—</td>
                    <td id="carRepairMonthly">—</td>
                </tr>
                <tr>
                    <th>Professional Development</th>
                    <td id="profDevAnnual">—</td>
                    <td id="profDevMonthly">—</td>
                </tr>
                <tr>
                    <th>Books & Periodicals</th>
                    <td id="booksAnnual">—</td>
                    <td id="booksMonthly">—</td>
                </tr>
                <tr>
                    <th>Special Allowance (Balancing Figure)</th>
                    <td id="specialAllowanceAnnual">—</td>
                    <td id="specialAllowanceMonthly">—</td>
                </tr>
                
                <!-- E) Subtotal: FIXED CTC (Blue) -->
                <tr class="subtotal-bar subtotal-bar-blue">
                    <th>FIXED CTC (Annual Gross Salary)</th>
                    <td id="fixedCTCAnnual">—</td>
                    <td id="fixedCTCMonthly">—</td>
                </tr>

                <!-- D) Section 2: Employer Savings (PF) -->
                <tr class="section-header-band">
                    <th colspan="3">II. Employer Savings (PF)</th>
                </tr>
                <tr>
                    <th>Employer PF Contribution (<span id="pfRateDisplay">12% of Basic Salary</span>)</th>
                    <td id="employerPFAnnual">—</td>
                    <td id="employerPFMonthly">—</td>
                </tr>

                <!-- D) Section 3: Cost to Company (Total CTC) -->
                <tr class="section-header-band">
                    <th colspan="3">III. Cost to Company (Total CTC)</th>
                </tr>
                <!-- E) Subtotal: TOTAL CTC (Blue) -->
                <tr class="subtotal-bar subtotal-bar-blue">
                    <th>ANNUAL CTC</th>
                    <td id="annualCTC">—</td>
                    <td id="monthlyCTC">—</td>
                </tr>
                
                <!-- D) Section 4: Employee Deductions -->
                <tr class="section-header-band">
                    <th colspan="3">IV. Employee Deductions</th>
                </tr>
                
                <!-- Deductions -->
                <tr>
                    <th>Employee PF Contribution</th>
                    <td id="employeePFAnnual">—</td>
                    <td id="employeePFMonthly">—</td>
                </tr>
                <tr>
                    <th>Professional Tax</th>
                    <td id="ptAnnual">—</td>
                    <td id="ptMonthly">—</td>
                </tr>
                <!-- E) Subtotal: Income Tax Estimate (Orange) -->
                <tr class="subtotal-bar subtotal-bar-tax">
                    <th>Estimated Income Tax (<span id="regimeDisplay">New Regime (Slab Tax)</span>)</th>
                    <td id="incomeTaxAnnual">—</td>
                    <td id="incomeTaxMonthly">—</td>
                </tr>
                
                <!-- E) Subtotal: TOTAL DEDUCTION (Purple) -->
                <tr class="subtotal-bar subtotal-bar-deduction">
                    <th>TOTAL DEDUCTION</th>
                    <td id="totalDeductionAnnual">—</td>
                    <td id="totalDeductionMonthly">—</td>
                </tr>
                
                <!-- D) Section 5: Net Take Home (Final) -->
                <tr class="section-header-band">
                    <th colspan="3">V. Net Take Home (Final)</th>
                </tr>
                <!-- E) Final Take Home (Green 3) -->
                <tr class="subtotal-bar subtotal-bar-net">
                    <th>TOTAL NET TAKE HOME (ESTIMATE)</th>
                    <td id="netTakeHomeAnnual">—</td>
                    <td id="netTakeHomeMonthly">—</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="flex justify-center mt-6">
        <!-- 5. PDF BUTTON (Blue) -->
        <button onclick="downloadPDF()" class="bg-[#55AAC3] hover:bg-[#3F8DA6] text-white font-semibold py-2 px-6 rounded-lg shadow-lg transition duration-150 flex items-center">
             <!-- Document/Download Icon -->
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            Download Full PDF Report
        </button>
    </div>
    <p class="text-xs text-gray-500 mt-4 text-center" style="color: #323232;">Disclaimer: This tool provides an <strong>estimation</strong> strictly based on the defined model logic. Actual tax and net take-home salary may vary significantly.</p>

</div>

<!-- jsPDF and html2canvas CDNs for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
    // --- CONFIGURATION CONSTANTS ---
    const CEA_ANNUAL = 2400;
    const TELEPHONE_ANNUAL = 36000;
    const SODEXO_ANNUAL = 36000;
    const CAR_REPAIR_ANNUAL = 28000;
    const PROF_DEV_ANNUAL = 36000;
    const BOOKS_ANNUAL = 36000;
    const PROFESSIONAL_TAX_ANNUAL = 2400;
    const MONTHS_PER_YEAR = 12;

    // --- 4. NUMBER FORMATTING (English-India Excel style) ---
    const formatCurrencyDisplay = (value) => {
        // Replace zero values with a dash '—'
        if (value === 0 || value === null || isNaN(value)) {
            return '—';
        }

        const roundedValue = Math.round(value);
        const isNegative = roundedValue < 0;
        const absValue = Math.abs(roundedValue);

        // Use en-US locale for Western grouping (600,000)
        const numberFormatter = new Intl.NumberFormat('en-US', {
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });

        const numberString = numberFormatter.format(absValue);

        // Construct the final string: [optional -] + ₹ + Space + numberString
        let result = `₹ ${numberString}`;

        if (isNegative) {
            result = `-${result}`;
        }
        
        return result;
    };
    
    // --- TAX CALCULATION HELPERS (Based on the prompt slabs) ---

    // New Regime Tax Slabs
    function computeNewRegimeTax(taxableIncome) {
        let tax = 0;
        let income = taxableIncome;
        
        // Slabs: 3L@0, 3-6L@5%, 6-9L@10%, 9-12L@15%, 12-15L@20%, >15L@30%
        if (income > 1500000) {
            tax += (income - 1500000) * 0.30;
            income = 1500000;
        }
        if (income > 1200000) {
            tax += (income - 1200000) * 0.20;
            income = 1200000;
        }
        if (income > 900000) {
            tax += (income - 900000) * 0.15;
            income = 900000;
        }
        if (income > 600000) {
            tax += (income - 600000) * 0.10;
            income = 600000;
        }
        if (income > 300000) {
            tax += (income - 300000) * 0.05;
            income = 300000;
        }
        
        // Apply 4% Cess (Health and Education Cess)
        let totalTax = tax * 1.04; 
        
        return Math.round(Math.max(0, totalTax));
    }

    // Old Regime Tax Slabs
    function computeOldRegimeTax(taxableIncome) {
        let tax = 0;
        let income = taxableIncome;

        // Slabs: 2.5L@0, 2.5-5L@5%, 5-10L@20%, >10L@30%
        if (income > 1000000) {
            tax += (income - 1000000) * 0.30;
            income = 1000000;
        }
        if (income > 500000) {
            tax += (income - 500000) * 0.20;
            income = 500000;
        }
        if (income > 250000) {
            tax += (income - 250000) * 0.05;
            income = 250000;
        }
        
        // Apply 4% Cess (Health and Education Cess)
        let totalTax = tax * 1.04;

        return Math.round(Math.max(0, totalTax));
    }

    // Helper to clear all results to '—' (C)
    function clearResults() {
        const ids = [
            'annualCTC', 'monthlyCTC', 'basicAnnual', 'basicMonthly', 'hraAnnual', 'hraMonthly', 
            'ltaAnnual', 'ltaMonthly', 'ceaAnnual', 'ceaMonthly', 'telephoneAnnual', 'telephoneMonthly', 
            'sodexoAnnual', 'sodexoMonthly', 'carRepairAnnual', 'carRepairMonthly', 'profDevAnnual', 'profDevMonthly', 
            'booksAnnual', 'booksMonthly', 'specialAllowanceAnnual', 'specialAllowanceMonthly', 
            'fixedCTCAnnual', 'fixedCTCMonthly', 'employerPFAnnual', 'employerPFMonthly', 'employeePFAnnual', 'employeePFMonthly', 
            'ptAnnual', 'ptMonthly', 'incomeTaxAnnual', 'incomeTaxMonthly', 
            'totalDeductionAnnual', 'totalDeductionMonthly', 'netTakeHomeAnnual', 'netTakeHomeMonthly',
            'summaryAnnualCTC', 'summaryNetTakeHomeMonthly' /* Summary Card (B) */
        ];
        
        ids.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.textContent = '—';
        });
        
        // Reset dynamic displays and Summary Card texts
        const pfOption = document.getElementById('pfOption');
        const taxRegime = document.getElementById('taxRegime');

        document.getElementById('pfRateDisplay').textContent = pfOption.options[pfOption.selectedIndex].textContent;
        document.getElementById('regimeDisplay').textContent = taxRegime.options[taxRegime.selectedIndex].textContent;
        document.getElementById('summaryPFMode').textContent = pfOption.options[pfOption.selectedIndex].textContent;
        document.getElementById('summaryTaxRegime').textContent = taxRegime.options[taxRegime.selectedIndex].textContent;
    }


    // --- MAIN CTC CALCULATION ---
    
    function calculateCTC() {
        const grossSalaryInput = document.getElementById('grossSalary').value;
        const annual_gross_salary = parseFloat(grossSalaryInput) || 0;
        
        const pf_mode_selection = document.getElementById('pfOption').value;
        const tax_regime = document.getElementById('taxRegime').value;
        const pf_mode = (pf_mode_selection === 'percentage') ? 'PERCENT_12' : 'CAP_1800';

        if (annual_gross_salary <= 0 && grossSalaryInput !== '0') {
            clearResults();
            return;
        }
        
        // --- 1) ANNUAL CTC (Derived from Gross) ---
        // Note: The logic fixed_ctc_annual * 0.94 should equal gross_salary.
        // We use annual_ctc = annual_gross_salary / 0.94
        const annual_ctc = Math.round(annual_gross_salary / 0.94);

        // --- 2) BASIC (50% of CTC) AND HRA (40% OF BASIC) ---
        const basic_annual = Math.round(annual_ctc * 0.50);
        const basic_monthly = Math.round(basic_annual / MONTHS_PER_YEAR);
        const hra_annual = Math.round(basic_annual * 0.40);
        const hra_monthly = Math.round(hra_annual / MONTHS_PER_YEAR);

        // --- 3) ALLOWANCES (fixed annuals are constants) ---
        const lta_annual = basic_monthly;
        const lta_monthly = Math.round(lta_annual / MONTHS_PER_YEAR);

        const cea_annual = CEA_ANNUAL;
        const telephone_annual = TELEPHONE_ANNUAL;
        const sodexo_annual = SODEXO_ANNUAL;
        const car_repair_annual = CAR_REPAIR_ANNUAL;
        const prof_dev_annual = PROF_DEV_ANNUAL;
        const books_annual = BOOKS_ANNUAL;

        const cea_monthly = Math.round(cea_annual / MONTHS_PER_YEAR);
        const telephone_monthly = Math.round(telephone_annual / MONTHS_PER_YEAR);
        const sodexo_monthly = Math.round(sodexo_annual / MONTHS_PER_YEAR);
        const car_repair_monthly = Math.round(car_repair_annual / MONTHS_PER_YEAR);
        const prof_dev_monthly = Math.round(prof_dev_annual / MONTHS_PER_YEAR);
        const books_monthly = Math.round(books_annual / MONTHS_PER_YEAR);
        
        // --- 4) SPECIAL ALLOWANCE & FIXED CTC ---
        const sum_fixed_components_without_special =
            basic_annual + hra_annual + lta_annual + cea_annual + telephone_annual
            + sodexo_annual + car_repair_annual + prof_dev_annual + books_annual;

        const special_allowance_annual = annual_ctc - sum_fixed_components_without_special;
        const special_allowance_monthly = Math.round(special_allowance_annual / MONTHS_PER_YEAR);

        const fixed_ctc_annual = sum_fixed_components_without_special + special_allowance_annual;
        const fixed_ctc_monthly = Math.round(fixed_ctc_annual / MONTHS_PER_YEAR);
        
        // --- 5) PROVIDENT FUND – 2 MODES ---
        let employer_pf_annual, employer_pf_monthly;

        if (pf_mode === "PERCENT_12") {
            employer_pf_annual = Math.round(basic_annual * 0.12);
            employer_pf_monthly = Math.round(employer_pf_annual / MONTHS_PER_YEAR);
        } else { // pf_mode === "CAP_1800"
            employer_pf_monthly = 1800;
            employer_pf_annual = employer_pf_monthly * MONTHS_PER_YEAR;
        }

        const employee_pf_annual = employer_pf_annual;
        const employee_pf_monthly = employer_pf_monthly;

        // --- 6) TOTAL CTC ---
        const total_ctc_annual = fixed_ctc_annual + employer_pf_annual;
        const total_ctc_monthly = fixed_ctc_monthly + employer_pf_monthly;

        // --- 7) EMPLOYEE DEDUCTIONS ---
        const prof_tax_annual = PROFESSIONAL_TAX_ANNUAL;
        const prof_tax_monthly = Math.round(prof_tax_annual / MONTHS_PER_YEAR);

        const taxable_income = fixed_ctc_annual;
        let income_tax_annual;
        
        if (tax_regime === "new") {
            income_tax_annual = computeNewRegimeTax(taxable_income);
        } else {
            income_tax_annual = computeOldRegimeTax(taxable_income); 
        }

        const income_tax_monthly = Math.round(income_tax_annual / MONTHS_PER_YEAR);

        const total_deductions_annual = employee_pf_annual + prof_tax_annual + income_tax_annual;
        const total_deductions_monthly = employee_pf_monthly + prof_tax_monthly + income_tax_monthly;

        // --- 8) NET TAKE-HOME (ESTIMATE) ---
        const net_take_home_annual = fixed_ctc_annual - total_deductions_annual;
        const net_take_home_monthly = fixed_ctc_monthly - total_deductions_monthly;

        // --- FINAL UI UPDATE ---

        // Update dynamic text displays
        const pfOption = document.getElementById('pfOption');
        const taxRegime = document.getElementById('taxRegime');
        document.getElementById('pfRateDisplay').textContent = pfOption.options[pfOption.selectedIndex].textContent;
        document.getElementById('regimeDisplay').textContent = taxRegime.options[taxRegime.selectedIndex].textContent;
        
        // Summary Card Update (B)
        document.getElementById('summaryAnnualCTC').textContent = formatCurrencyDisplay(total_ctc_annual);
        document.getElementById('summaryNetTakeHomeMonthly').textContent = formatCurrencyDisplay(net_take_home_monthly);
        document.getElementById('summaryPFMode').textContent = pfOption.options[pfOption.selectedIndex].textContent;
        document.getElementById('summaryTaxRegime').textContent = taxRegime.options[taxRegime.selectedIndex].textContent;

        // Table updates
        document.getElementById('annualCTC').textContent = formatCurrencyDisplay(total_ctc_annual);
        document.getElementById('monthlyCTC').textContent = formatCurrencyDisplay(total_ctc_monthly);
        document.getElementById('basicAnnual').textContent = formatCurrencyDisplay(basic_annual);
        document.getElementById('basicMonthly').textContent = formatCurrencyDisplay(basic_monthly);
        document.getElementById('hraAnnual').textContent = formatCurrencyDisplay(hra_annual);
        document.getElementById('hraMonthly').textContent = formatCurrencyDisplay(hra_monthly);
        document.getElementById('ltaAnnual').textContent = formatCurrencyDisplay(lta_annual);
        document.getElementById('ltaMonthly').textContent = formatCurrencyDisplay(lta_monthly);
        document.getElementById('ceaAnnual').textContent = formatCurrencyDisplay(cea_annual);
        document.getElementById('ceaMonthly').textContent = formatCurrencyDisplay(cea_monthly);
        document.getElementById('telephoneAnnual').textContent = formatCurrencyDisplay(telephone_annual);
        document.getElementById('telephoneMonthly').textContent = formatCurrencyDisplay(telephone_monthly);
        document.getElementById('sodexoAnnual').textContent = formatCurrencyDisplay(sodexo_annual);
        document.getElementById('sodexoMonthly').textContent = formatCurrencyDisplay(sodexo_monthly);
        document.getElementById('carRepairAnnual').textContent = formatCurrencyDisplay(car_repair_annual);
        document.getElementById('carRepairMonthly').textContent = formatCurrencyDisplay(car_repair_monthly);
        document.getElementById('profDevAnnual').textContent = formatCurrencyDisplay(prof_dev_annual);
        document.getElementById('profDevMonthly').textContent = formatCurrencyDisplay(prof_dev_monthly);
        document.getElementById('booksAnnual').textContent = formatCurrencyDisplay(books_annual);
        document.getElementById('booksMonthly').textContent = formatCurrencyDisplay(books_monthly);
        document.getElementById('specialAllowanceAnnual').textContent = formatCurrencyDisplay(special_allowance_annual);
        document.getElementById('specialAllowanceMonthly').textContent = formatCurrencyDisplay(special_allowance_monthly);
        document.getElementById('fixedCTCAnnual').textContent = formatCurrencyDisplay(fixed_ctc_annual);
        document.getElementById('fixedCTCMonthly').textContent = formatCurrencyDisplay(fixed_ctc_monthly);
        document.getElementById('employerPFAnnual').textContent = formatCurrencyDisplay(employer_pf_annual);
        document.getElementById('employerPFMonthly').textContent = formatCurrencyDisplay(employer_pf_monthly);
        document.getElementById('employeePFAnnual').textContent = formatCurrencyDisplay(employee_pf_annual);
        document.getElementById('employeePFMonthly').textContent = formatCurrencyDisplay(employee_pf_monthly);
        document.getElementById('ptAnnual').textContent = formatCurrencyDisplay(prof_tax_annual);
        document.getElementById('ptMonthly').textContent = formatCurrencyDisplay(prof_tax_monthly);
        document.getElementById('incomeTaxAnnual').textContent = formatCurrencyDisplay(income_tax_annual);
        document.getElementById('incomeTaxMonthly').textContent = formatCurrencyDisplay(income_tax_monthly);
        document.getElementById('totalDeductionAnnual').textContent = formatCurrencyDisplay(total_deductions_annual);
        document.getElementById('totalDeductionMonthly').textContent = formatCurrencyDisplay(total_deductions_monthly);
        document.getElementById('netTakeHomeAnnual').textContent = formatCurrencyDisplay(net_take_home_annual);
        document.getElementById('netTakeHomeMonthly').textContent = formatCurrencyDisplay(net_take_home_monthly);
    }
    
    function toggleOldRegimeAllowances() {
        const regime = document.getElementById('taxRegime').value;
        const allowancesDiv = document.getElementById('oldRegimeAllowances');
        if (regime === 'old') {
            allowancesDiv.classList.remove('hidden');
        } else {
            allowancesDiv.classList.add('hidden');
        }
        calculateCTC(); // Recalculate when regime changes
    }

    // --- PDF Download Functionality ---
    async function downloadPDF() {
        const input = document.getElementById('results-container'); 
        const { jsPDF } = window.jspdf;
        
        if (!input) {
            console.error("PDF Error: 'results-container' element not found.");
            const messageBox = document.createElement('div');
            messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid red; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.2);';
            messageBox.innerHTML = '<strong>Error!</strong> Could not find the table to generate the PDF. Please try refreshing the page.';
            document.body.appendChild(messageBox);
            setTimeout(() => document.body.removeChild(messageBox), 4000);
            return;
        }

        calculateCTC(); 

        html2canvas(input, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgHeight = (canvas.height * pdfWidth) / canvas.width;

            // Add title text
            pdf.setFontSize(16);
            pdf.text('India CTC Breakdown & Net Take Home Estimate', pdfWidth / 2, 15, { align: 'center' });
            pdf.setFontSize(10);
            pdf.text('Generated on: ' + new Date().toLocaleDateString(), pdfWidth / 2, 22, { align: 'center' });

            // Add image of the table
            pdf.addImage(imgData, 'PNG', 10, 30, pdfWidth - 20, imgHeight * (pdfWidth - 20) / pdfWidth);
            
            // Add disclaimer
            pdf.setFontSize(8);
            pdf.text('Disclaimer: This tool provides an **estimation** for illustrative purposes only. Actual net take-home salary may vary based on company policies, investment declarations, and final tax calculations.', 10, pdfHeight - 10);
            
            pdf.save("CTC_Breakdown_Report.pdf");
        }).catch(error => {
            console.error("Error generating PDF:", error);
            const messageBox = document.createElement('div');
            messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid red; border-radius: 10px; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.2);';
            messageBox.innerHTML = '<strong>Error!</strong> Could not generate PDF. Please try again or check the console for details.';
            document.body.appendChild(messageBox);
            setTimeout(() => document.body.removeChild(messageBox), 3000);
        });
    }

    // Initialize on load
    window.onload = function() {
        clearResults(); 
        calculateCTC(); 
        toggleOldRegimeAllowances();
    };

</script>

</body>
</html>